import os
import sys
import socket
from flask import Flask, request, jsonify
import sqlite3 as sq
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

def get_ip_address():
    """Ø¯Ø±ÛŒØ§ÙØª IP Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©"""
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except:
        return "IP-Ù†Ø§Ù…Ø´Ø®Øµ"

def get_student_scores(student_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ù†Ù…Ø±Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²"""
    try:
        conn = sq.connect('Nokhbino.sqlite')
        cursor = conn.cursor()
        
        classes = ['701', '702', '703', '704', '801', '802', '901']
        for class_name in classes:
            cursor.execute(f'SELECT * FROM class{class_name} WHERE id = ?', (student_id,))
            result = cursor.fetchone()
            if result:
                columns = [description[0] for description in cursor.description]
                student_data = dict(zip(columns, result))
                student_data['class_name'] = class_name
                conn.close()
                return student_data
        conn.close()
        return None
    except Exception as e:
        print(f"Ø®Ø·Ø§: {e}")
        return None

@app.route('/api/get_scores', methods=['POST', 'GET'])
def get_scores():
    """Ø¯Ø±ÛŒØ§ÙØª Ù†Ù…Ø±Ø§Øª"""
    try:
        if request.method == 'GET':
            student_id = request.args.get('student_id')
        else:
            data = request.get_json()
            student_id = data.get('student_id')
        
        if not student_id:
            return jsonify({'success': False, 'message': 'Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'})
        
        student_data = get_student_scores(student_id)
        if student_data:
            response = {
                'success': True,
                'student_id': student_id,
                'name': student_data.get('name'),
                'surname': student_data.get('surname'),
                'class_name': student_data.get('class_name'),
                'scores': {}
            }
            
            subjects_mapping = {
                'art': 'Ù‡Ù†Ø±', 'sport': 'ÙˆØ±Ø²Ø´', 'english': 'Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ',
                'technology': 'Ú©Ø§Ø± Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ', 'socialstudies': 'Ù…Ø·Ø§Ù„Ø¹Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ',
                'writing': 'Ù†Ú¯Ø§Ø±Ø´', 'dictation': 'Ø§Ù…Ù„Ø§', 'literature': 'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ',
                'math': 'Ø±ÛŒØ§Ø¶ÛŒ', 'science': 'Ø¹Ù„ÙˆÙ…', 'arabic': 'Ø¹Ø±Ø¨ÛŒ',
                'thinkinglifestyle': 'ØªÙÚ©Ø± Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ', 'religious': 'Ø¯ÛŒÙ†ÛŒ',
                'quran': 'Ù‚Ø±Ø¢Ù†', 'plusone': 'Ù…Ø«Ø¨Øª ÛŒÚ©'
            }
            
            if student_data['class_name'] == '901':
                subjects_mapping['defensive'] = 'Ø¢Ù…Ø§Ø¯Ú¯ÛŒ Ø¯ÙØ§Ø¹ÛŒ'
            
            for eng_key, persian_name in subjects_mapping.items():
                if eng_key in student_data:
                    response['scores'][persian_name] = student_data[eng_key]
            
            return jsonify(response)
        else:
            return jsonify({'success': False, 'message': 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÛŒØ§ÙØª Ù†Ø´Ø¯'})
            
    except Exception as e:
        return jsonify({'success': False, 'message': f'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: {str(e)}'})

@app.route('/api/health', methods=['GET'])
def health_check():
    return jsonify({'status': 'active', 'message': 'Ø³Ø±ÙˆØ± Ù…Ø¯Ø±Ø³Ù‡ Ù†Ø®Ø¨ÛŒÙ†Ùˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª'})

if __name__ == '__main__':
    ip = get_ip_address()
    print("=" * 50)
    print("ğŸ“ Ø³Ø±ÙˆØ± Ù…Ø¯Ø±Ø³Ù‡ Ù†Ø®Ø¨ÛŒÙ†Ùˆ")
    print("ğŸ“ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ:")
    print(f"   http://localhost:5000")
    print(f"   http://{ip}:5000")
    print("=" * 50)
    print("ğŸ“± Ø¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù†Ø¯:")
    print(f"   http://{ip}:5000")
    print("=" * 50)
    print("âš¡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±...")
    
    app.run(host='0.0.0.0', port=5000, debug=False)