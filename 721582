import tkinter as tk
from tkinter import ttk, messagebox
import requests
import json

class StudentApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…Ø±Ø§Øª - Ù…Ø¯Ø±Ø³Ù‡ Ù†Ø®Ø¨ÛŒÙ†Ùˆ")
        self.root.geometry("400x300")
        self.root.configure(bg='#f0f8ff')
        
        # Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± - Ù…Ø¯ÛŒØ± Ø§ÛŒÙ† Ø±Ø§ Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        self.server_ip = "192.168.1.100"  # ðŸ”´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯ Ø¨Ø§ IP Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ù…Ø¯Ø±Ø³Ù‡
        self.server_url = f"http://{self.server_ip}:5000"
        
        self.setup_ui()
    
    def setup_ui(self):
        # Ù‡Ø¯Ø±
        header_frame = tk.Frame(self.root, bg='#2e86ab')
        header_frame.pack(fill='x', padx=10, pady=10)
        
        tk.Label(header_frame, text="Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…Ø±Ø§Øª", 
                font=('B Nazanin', 16, 'bold'), 
                fg='white', bg='#2e86ab').pack(pady=5)
        
        tk.Label(header_frame, text="Ù…Ø¯Ø±Ø³Ù‡ Ù†Ø®Ø¨ÛŒÙ†Ùˆ", 
                font=('B Nazanin', 12), 
                fg='white', bg='#2e86ab').pack()
        
        # ÙØ±ÛŒÙ… ÙˆØ±ÙˆØ¯
        login_frame = tk.Frame(self.root, bg='#e8f4f8', relief='ridge', bd=2)
        login_frame.pack(fill='x', padx=20, pady=20)
        
        tk.Label(login_frame, text="Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ:", 
                font=('B Nazanin', 12), bg='#e8f4f8').pack(pady=10)
        
        self.student_id_entry = tk.Entry(login_frame, font=('Arial', 14),
                                        justify='center', width=20)
        self.student_id_entry.pack(pady=10)
        
        self.search_btn = tk.Button(login_frame, text="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…Ø±Ø§Øª", 
                                   command=self.get_scores,
                                   bg='#4CAF50', fg='white',
                                   font=('B Nazanin', 12, 'bold'),
                                   width=15, height=2)
        self.search_btn.pack(pady=15)
        
        # ÙˆØ¶Ø¹ÛŒØª
        self.status_label = tk.Label(self.root, text="", 
                                    font=('B Nazanin', 10), 
                                    bg='#f0f8ff', fg='blue')
        self.status_label.pack(pady=5)

    def get_scores(self):
        student_id = self.student_id_entry.get().strip()
        
        if not student_id:
            messagebox.showwarning("Ù‡Ø´Ø¯Ø§Ø±", "Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯")
            return
        
        self.search_btn.config(text="Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...", state='disabled')
        
        try:
            response = requests.post(
                f"{self.server_url}/api/get_scores",
                json={'student_id': student_id},
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data['success']:
                    self.show_results(data)
                else:
                    messagebox.showerror("Ø®Ø·Ø§", data['message'])
            else:
                messagebox.showerror("Ø®Ø·Ø§", "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù…Ø¯Ø±Ø³Ù‡")
                
        except requests.exceptions.RequestException:
            messagebox.showerror("Ø®Ø·Ø§", 
                "Ø¹Ø¯Ù… Ø§Ù…Ú©Ø§Ù† Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±\n"
                "âœ… Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯:\n"
                "1. Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± Ù…Ø¯Ø±Ø³Ù‡ Ø±ÙˆØ´Ù† Ø§Ø³Øª\n"
                "2. Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…ØªØµÙ„ Ù‡Ø³ØªÛŒØ¯\n"
                "3. Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± ØµØ­ÛŒØ­ Ø§Ø³Øª"
            )
        finally:
            self.search_btn.config(text="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…Ø±Ø§Øª", state='normal')
    
    def show_results(self, data):
        result_window = tk.Toplevel(self.root)
        result_window.title("Ù†Ù…Ø±Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²")
        result_window.geometry("500x600")
        result_window.configure(bg='#f0f8ff')
        
        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        info_frame = tk.Frame(result_window, bg='#d4edda', relief='ridge', bd=2)
        info_frame.pack(fill='x', padx=10, pady=10)
        
        info_text = f"ðŸŽ“ {data['name']} {data['surname']} - Ú©Ù„Ø§Ø³ {data['class_name']}"
        tk.Label(info_frame, text=info_text, 
                font=('B Nazanin', 14, 'bold'), 
                bg='#d4edda').pack(pady=10)
        
        # Ø¬Ø¯ÙˆÙ„ Ù†Ù…Ø±Ø§Øª
        tree_frame = tk.Frame(result_window, bg='#f0f8ff')
        tree_frame.pack(expand=True, fill='both', padx=10, pady=10)
        
        tree = ttk.Treeview(tree_frame, columns=("Ø¯Ø±Ø³", "Ù†Ù…Ø±Ù‡", "ÙˆØ¶Ø¹ÛŒØª"), show='headings', height=15)
        tree.heading("Ø¯Ø±Ø³", text="Ø¯Ø±Ø³")
        tree.heading("Ù†Ù…Ø±Ù‡", text="Ù†Ù…Ø±Ù‡") 
        tree.heading("ÙˆØ¶Ø¹ÛŒØª", text="ÙˆØ¶Ø¹ÛŒØª")
        
        tree.column("Ø¯Ø±Ø³", width=200)
        tree.column("Ù†Ù…Ø±Ù‡", width=100)
        tree.column("ÙˆØ¶Ø¹ÛŒØª", width=100)
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
        total = 0
        count = 0
        
        for subject, score in data['scores'].items():
            if score is not None:
                try:
                    score_val = float(score)
                    total += score_val
                    count += 1
                    status = "âœ… Ù‚Ø¨ÙˆÙ„" if score_val >= 10 else "âŒ Ù…Ø±Ø¯ÙˆØ¯"
                    tree.insert("", "end", values=(subject, f"{score_val:.1f}", status))
                except:
                    tree.insert("", "end", values=(subject, "Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡", "---"))
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        tree.pack(side='left', expand=True, fill='both')
        scrollbar.pack(side='right', fill='y')
        
        # Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†
        if count > 0:
            avg = total / count
            avg_frame = tk.Frame(result_window, bg='#fff3cd', relief='ridge', bd=2)
            avg_frame.pack(fill='x', padx=10, pady=10)
            
            avg_text = f"ðŸ“Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù†Ù…Ø±Ø§Øª: {avg:.2f}"
            tk.Label(avg_frame, text=avg_text, 
                    font=('B Nazanin', 12, 'bold'), 
                    bg='#fff3cd').pack(pady=8)

def main():
    root = tk.Tk()
    app = StudentApp(root)
    root.mainloop()

if __name__ == "__main__":
    main()